provider "azurerm" {
  client_id       = "cca65dcd-3aa3-44d3-81cb-6b57b764be6a"
  client_secret   = "3xiqCSscx/CScQY3XInaRz+hFccS+zOAjgwvqlUZTeo="
  tenant_id       = "608c3255-376b-47a4-8e8e-9291e506d03e"
  subscription_id = "d159e994-8b44-42f7-b100-78c4508c34a6"
}

resource "azurerm_resource_group" "app" {
  name     = "demo"
  location = "centralus"
}


resource "azurerm_availability_set" "app" {
  name                = "demo-app-availability-set"
  location            = "${azurerm_resource_group.app.location}"
  resource_group_name = "${azurerm_resource_group.app.name}"
  managed             = true
}

resource "azurerm_virtual_network" "app" {
  name                = "demonetwork"
  address_space       = ["${split(",", "10.0.0.0/16")}"]
  location            = "${azurerm_resource_group.app.location}"
  resource_group_name  = "${azurerm_resource_group.app.name}"
}

resource "azurerm_subnet" "app" {
  name                 = "app"
  resource_group_name  = "${azurerm_resource_group.app.name}"
  address_prefix       = "10.0.1.0/24"
  virtual_network_name =  "${azurerm_virtual_network.app.name}" 
}

resource "azurerm_network_security_group" "app" {
  name                = "demo-app-sg"
  location            = "${azurerm_resource_group.app.location}"
  resource_group_name = "${azurerm_resource_group.app.name}"

}

resource "azurerm_public_ip" "app" {
    name                         = "demo-app-ip"
    location                     = "${azurerm_resource_group.app.location}"
    resource_group_name          = "${azurerm_resource_group.app.name}"
    public_ip_address_allocation = "dynamic"
    idle_timeout_in_minutes      = 30
}

resource "azurerm_lb" "app" {
    name                         = "demo-app-lb"
    location                     = "${azurerm_resource_group.app.location}"
    resource_group_name          = "${azurerm_resource_group.app.name}"

    frontend_ip_configuration {
        name                 = "demo-app-lb-ip"
        public_ip_address_id          = "${azurerm_public_ip.app.id}" 
    }
}

resource "azurerm_lb_backend_address_pool" "app" {
  resource_group_name          = "${azurerm_resource_group.app.name}"
  loadbalancer_id              = "${azurerm_lb.app.id}"
  name                         = "demo-app-lb-backend-address-pool"
}


resource "azurerm_network_interface" "app" {
    count                     = 1
    name                      = "demo-app-ni-${count.index}"
    location                  = "${azurerm_resource_group.app.location}"
    resource_group_name       = "${azurerm_resource_group.app.name}"
    network_security_group_id =  "${azurerm_network_security_group.app.id}" 

    ip_configuration {
        name                                    = "demo-app-ni-ipConfig-${count.index}"
        subnet_id                               = "${azurerm_subnet.app.id}"
        private_ip_address_allocation           = "dynamic"
        load_balancer_backend_address_pools_ids = ["${azurerm_lb_backend_address_pool.app.id}"]
    }
}

resource "azurerm_virtual_machine" "app-0" {
    name                  = "demo-app-vm-0"
    location              = "${azurerm_resource_group.app.location}"
    resource_group_name   = "${azurerm_resource_group.app.name}"
    network_interface_ids = ["${element(azurerm_network_interface.app.*.id, 0)}"]
    vm_size               = "Standard_A0"

    availability_set_id   = "${azurerm_availability_set.app.id}"

    delete_os_disk_on_termination = true
    delete_data_disks_on_termination = true

    storage_image_reference {
        publisher = "Canonical"
        offer     = "UbuntuServer"
        sku       = "16.04-LTS"
        version   = "latest"
    }

    storage_os_disk {
        name              = "demo-app-osDisk-0"
        caching           = "ReadWrite"
        create_option     = "FromImage"
        managed_disk_type = "standard_LRS"
    }



    os_profile {
        computer_name  = "app"
        admin_username = "ubuntu"
        admin_password = "Password1234!"
    }

    os_profile_linux_config {
        disable_password_authentication = false

    }


    tags {
        soajs.env.code = "TEST"
        soajs.layer.name = "app"
        soajs.network.name =  "demo-vn" 
        soajs.vm.name = "demo-app-vm-0"
    }
}

