provider "azurerm" {
  client_id       = "cca65dcd-3aa3-44d3-81cb-6b57b764be6a"
  client_secret   = "3xiqCSscx/CScQY3XInaRz+hFccS+zOAjgwvqlUZTeo="
  tenant_id       = "608c3255-376b-47a4-8e8e-9291e506d03e"
  subscription_id = "d159e994-8b44-42f7-b100-78c4508c34a6"
}

resource "azurerm_resource_group" "datalayer" {
  name     = "demo"
  location = "centralus"
}


resource "azurerm_virtual_network" "datalayer" {
  name                = "demonetwork"
  address_space       = ["${split(",", "10.0.0.0/16")}"]
  location            = "${azurerm_resource_group.datalayer.location}"
  resource_group_name  = "${azurerm_resource_group.datalayer.name}"
}

resource "azurerm_subnet" "datalayer" {
  name                 = "datalayer"
  resource_group_name  = "${azurerm_resource_group.datalayer.name}"
  address_prefix       = "10.0.1.0/24"
  virtual_network_name =  "${azurerm_virtual_network.datalayer.name}" 
}

resource "azurerm_network_security_group" "datalayer" {
  name                = "demo-datalayer-sg"
  location            = "${azurerm_resource_group.datalayer.location}"
  resource_group_name = "${azurerm_resource_group.datalayer.name}"

}

resource "azurerm_public_ip" "datalayer" {
    count                        = 2
    name                         = "demo-datalayer-ip-${count.index}"
    location                     = "${azurerm_resource_group.datalayer.location}"
    resource_group_name          = "${azurerm_resource_group.datalayer.name}"
    public_ip_address_allocation = "dynamic"
    idle_timeout_in_minutes      = 30
}

resource "azurerm_network_interface" "datalayer" {
    count                     = 2
    name                      = "demo-datalayer-ni-${count.index}"
    location                  = "${azurerm_resource_group.datalayer.location}"
    resource_group_name       = "${azurerm_resource_group.datalayer.name}"
    network_security_group_id =  "${azurerm_network_security_group.datalayer.id}" 

    ip_configuration {
        name                          = "demo-datalayer-ni-ipConfig-${count.index}"
        subnet_id                     = "${azurerm_subnet.datalayer.id}"
        private_ip_address_allocation = "dynamic"
        public_ip_address_id          = "${element(azurerm_public_ip.datalayer.*.id, count.index)}" 
    }
}

resource "azurerm_virtual_machine" "datalayer-0" {
    name                  = "demo-datalayer-vm-0"
    location              = "${azurerm_resource_group.datalayer.location}"
    resource_group_name   = "${azurerm_resource_group.datalayer.name}"
    network_interface_ids = ["${element(azurerm_network_interface.datalayer.*.id, 0)}"]
    vm_size               = "Standard_A0"

    delete_os_disk_on_termination = true
    delete_data_disks_on_termination = true

    storage_image_reference {
        publisher = "Canonical"
        offer     = "UbuntuServer"
        sku       = "16.04-LTS"
        version   = "latest"
    }

    storage_os_disk {
        name              = "demo-datalayer-osDisk-0"
        caching           = "ReadWrite"
        create_option     = "FromImage"
        managed_disk_type = "standard_LRS"
    }



    os_profile {
        computer_name  = "datalayer"
        admin_username = "ubuntu"
        admin_password = "Password1234!"
    }

    os_profile_linux_config {
        disable_password_authentication = false

    }


    tags {
        soajs.env.code = "DEV"
        soajs.layer.name = "datalayer"
        soajs.network.name =  "demo-vn" 
        soajs.vm.name = "demo-datalayer-vm-0"
    }
}

resource "azurerm_virtual_machine" "datalayer-1" {
    name                  = "demo-datalayer-vm-1"
    location              = "${azurerm_resource_group.datalayer.location}"
    resource_group_name   = "${azurerm_resource_group.datalayer.name}"
    network_interface_ids = ["${element(azurerm_network_interface.datalayer.*.id, 1)}"]
    vm_size               = "Standard_A0"

    delete_os_disk_on_termination = true
    delete_data_disks_on_termination = true

    storage_image_reference {
        publisher = "Canonical"
        offer     = "UbuntuServer"
        sku       = "16.04-LTS"
        version   = "latest"
    }

    storage_os_disk {
        name              = "demo-datalayer-osDisk-1"
        caching           = "ReadWrite"
        create_option     = "FromImage"
        managed_disk_type = "standard_LRS"
    }



    os_profile {
        computer_name  = "datalayer"
        admin_username = "ubuntu"
        admin_password = "Password1234!"
    }

    os_profile_linux_config {
        disable_password_authentication = false

    }


    tags {
        soajs.env.code = "DEV"
        soajs.layer.name = "datalayer"
        soajs.network.name =  "demo-vn" 
        soajs.vm.name = "demo-datalayer-vm-1"
    }
}

